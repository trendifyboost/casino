{% extends "admin/base.html" %}

{% block title %}Edit User - {{ user.full_name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-user-edit"></i> Edit User - {{ user.full_name }}</h1>
    <a href="{{ url_for('admin.users') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Back to Users
    </a>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- User Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-user"></i> User Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Full Name:</strong> {{ user.full_name }}</p>
                        <p><strong>Phone:</strong> {{ user.phone }}</p>
                        <p><strong>Username:</strong> {{ user.username or 'Not set' }}</p>
                        <p><strong>Referral Code:</strong> 
                           <span class="badge bg-primary">{{ user.referral_code }}</span>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Status:</strong> 
                           <span class="badge bg-{{ 'success' if user.is_active else 'danger' }}">
                               {{ 'Active' if user.is_active else 'Banned' }}
                           </span>
                        </p>
                        <p><strong>Joined:</strong> {{ user.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                        <p><strong>Last Login:</strong> 
                           {{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'Never' }}
                        </p>
                        <p><strong>Referred By:</strong> 
                           {% if user.referrer %}
                           <a href="{{ url_for('admin.edit_user', user_id=user.referrer.id) }}">
                               {{ user.referrer.full_name }}
                           </a>
                           {% else %}
                           Direct registration
                           {% endif %}
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Balance Management -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-wallet"></i> Balance Management</h5>
            </div>
            <div class="card-body">
                <form method="POST" class="mb-3">
                    <input type="hidden" name="action" value="update_balance">
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Current Balance</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" name="balance" 
                                           step="0.01" value="{{ user.balance }}" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Bonus Balance</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" name="bonus_balance" 
                                           step="0.01" value="{{ user.bonus_balance }}" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Referral Commission</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" name="referral_commission" 
                                           step="0.01" value="{{ user.referral_commission }}" required>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Update Balance
                    </button>
                </form>
                
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Warning:</strong> Manual balance changes will create transaction records for auditing purposes.
                </div>
            </div>
        </div>
        
        <!-- Account Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-cogs"></i> Account Actions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h6>Account Status</h6>
                        <form method="POST" class="d-inline">
                            <input type="hidden" name="action" value="toggle_status">
                            <button type="submit" class="btn btn-{{ 'danger' if user.is_active else 'success' }}">
                                <i class="fas fa-{{ 'ban' if user.is_active else 'check' }}"></i>
                                {{ 'Ban User' if user.is_active else 'Activate User' }}
                            </button>
                        </form>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <h6>Reset Password</h6>
                        <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#resetPasswordModal">
                            <i class="fas fa-key"></i> Reset Password
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Transactions -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-history"></i> Recent Transactions</h5>
            </div>
            <div class="card-body">
                {% if user.transactions %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for transaction in user.transactions[:10] %}
                            <tr>
                                <td>{{ transaction.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    <span class="badge bg-{{ 'success' if transaction.amount > 0 else 'danger' }}">
                                        {{ transaction.type.title() }}
                                    </span>
                                </td>
                                <td class="{{ 'text-success' if transaction.amount > 0 else 'text-danger' }}">
                                    ${{ "%.2f"|format(transaction.amount) }}
                                </td>
                                <td>{{ transaction.description }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center">No transactions found</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Quick Stats -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar"></i> Quick Stats</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <h4 class="text-success">${{ "%.2f"|format(user.balance) }}</h4>
                        <small class="text-muted">Main Balance</small>
                    </div>
                    <div class="col-6 mb-3">
                        <h4 class="text-warning">${{ "%.2f"|format(user.bonus_balance) }}</h4>
                        <small class="text-muted">Bonus Balance</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-info">${{ "%.2f"|format(user.referral_commission) }}</h4>
                        <small class="text-muted">Referral Commission</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-primary">{{ user.referred_users|length }}</h4>
                        <small class="text-muted">Referred Users</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Referred Users -->
        {% if user.referred_users %}
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-users"></i> Referred Users</h5>
            </div>
            <div class="card-body">
                {% for referred_user in user.referred_users[:5] %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <strong>{{ referred_user.full_name }}</strong><br>
                        <small class="text-muted">{{ referred_user.phone }}</small>
                    </div>
                    <div class="text-end">
                        <div class="text-success">${{ "%.2f"|format(referred_user.balance) }}</div>
                        <small class="text-muted">Balance</small>
                    </div>
                </div>
                {% if not loop.last %}<hr>{% endif %}
                {% endfor %}
                
                {% if user.referred_users|length > 5 %}
                <div class="text-center mt-2">
                    <small class="text-muted">and {{ user.referred_users|length - 5 }} more...</small>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Deposit/Withdrawal Summary -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-exchange-alt"></i> Transaction Summary</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h5 class="text-success">{{ user.deposits|selectattr('status', 'equalto', 'approved')|list|length }}</h5>
                        <small class="text-muted">Approved Deposits</small>
                    </div>
                    <div class="col-6">
                        <h5 class="text-danger">{{ user.withdrawals|selectattr('status', 'equalto', 'approved')|list|length }}</h5>
                        <small class="text-muted">Approved Withdrawals</small>
                    </div>
                </div>
                
                <hr>
                
                <div class="row text-center">
                    <div class="col-6">
                        <h5 class="text-warning">{{ user.deposits|selectattr('status', 'equalto', 'pending')|list|length }}</h5>
                        <small class="text-muted">Pending Deposits</small>
                    </div>
                    <div class="col-6">
                        <h5 class="text-warning">{{ user.withdrawals|selectattr('status', 'equalto', 'pending')|list|length }}</h5>
                        <small class="text-muted">Pending Withdrawals</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reset Password Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reset User Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST">
                <div class="modal-body">
                    <input type="hidden" name="action" value="reset_password">
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Warning:</strong> This will reset the password for {{ user.full_name }}.
                    </div>
                    
                    <div class="mb-3">
                        <label for="new_password" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="new_password" 
                               name="new_password" minlength="6" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="confirm_password" class="form-label">Confirm Password</label>
                        <input type="password" class="form-control" id="confirm_password" 
                               name="confirm_password" minlength="6" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-key"></i> Reset Password
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Password confirmation validation
    var newPasswordInput = document.getElementById('new_password');
    var confirmPasswordInput = document.getElementById('confirm_password');
    
    function validatePasswordMatch() {
        if (newPasswordInput.value !== confirmPasswordInput.value) {
            confirmPasswordInput.setCustomValidity('Passwords do not match');
        } else {
            confirmPasswordInput.setCustomValidity('');
        }
    }
    
    newPasswordInput.addEventListener('input', validatePasswordMatch);
    confirmPasswordInput.addEventListener('input', validatePasswordMatch);
    
    // Confirm dangerous actions
    var dangerousButtons = document.querySelectorAll('.btn-danger');
    dangerousButtons.forEach(function(button) {
        button.addEventListener('click', function(e) {
            var action = this.textContent.trim();
            if (!confirm('Are you sure you want to ' + action.toLowerCase() + '? This action cannot be undone.')) {
                e.preventDefault();
            }
        });
    });
});
</script>
{% endblock %}
